<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safe Vault</title> 
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#175DDC">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.34/dist/zip.min.js"></script>

    <style>
        :root { --primary: #175DDC; --bg: #f2f4f8; --card-bg: #ffffff; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding-top: 70px; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* HEADER */
        .header { background: var(--primary); padding: 10px 15px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; align-items: center; gap: 15px; height: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .search-container { flex: 1; position: relative; }
        .search-box { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: none; font-size: 15px; background: rgba(255,255,255,0.2); color: white; outline: none; box-sizing: border-box; backdrop-filter: blur(5px); }
        .search-box::placeholder { color: rgba(255,255,255,0.8); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.8); }
        .header-btn { color: white; font-size: 20px; cursor: pointer; }
        
        /* COUNTER */
        .badge { position: absolute; top: 8px; right: 45px; background: #ff4757; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* LIST CARD */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .card-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .brand-info { display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 36px; height: 36px; border-radius: 8px; object-fit: contain; }
        .brand-name { font-weight: 700; font-size: 17px; color: #333; }
        .card-actions { display: flex; gap: 15px; }
        .action-icon { color: #999; font-size: 18px; cursor: pointer; padding: 5px; }
        .action-icon.del { color: #ff6b6b; }

        .field-group { margin-bottom: 12px; background: #f9f9f9; padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
        .field-content { flex: 1; overflow: hidden; margin-right: 10px; }
        .field-label { font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 4px; font-weight: 600; letter-spacing: 0.5px; }
        .field-value { font-size: 15px; font-family: 'Roboto Mono', monospace; color: #333; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .copy-btn { background: white; border: 1px solid #dee2e6; color: var(--primary); font-weight: 700; font-size: 11px; padding: 6px 12px; border-radius: 6px; min-width: 60px; cursor: pointer; text-transform: uppercase; }
        .copy-btn.copied { background: #27ae60; color: white; border-color: #27ae60; }
        
        .note-box { background: #fff8e1; color: #d35400; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 10px; display: flex; align-items: flex-start; gap: 8px; }
        .web-link { display: block; text-align: right; margin-top: 12px; font-size: 13px; color: var(--primary); text-decoration: none; font-weight: 600; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; box-shadow: 0 10px 25px rgba(23, 93, 220, 0.4); z-index: 200; cursor: pointer; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 85%; max-width: 400px; border-radius: 20px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: popUp 0.2s ease-out; }
        .inp-group { margin-bottom: 15px; }
        .inp-label { display: block; font-size: 12px; font-weight: 700; color: #555; margin-bottom: 5px; }
        .inp { width: 100%; padding: 12px; border: 1px solid #eee; background: #f8f9fa; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        .inp:focus { border-color: var(--primary); background: white; }
        
        /* SYNC UI FIX */
        .sync-row { display: flex; gap: 8px; align-items: center; }
        .sync-row .inp { flex: 1; }
        .btn-sync { background: var(--primary); color: white; border: none; height: 45px; padding: 0 20px; border-radius: 10px; font-weight: bold; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 5px; }

        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; font-size: 15px; cursor: pointer; }
        .btn-close { background: #f1f3f5; color: #333; }
        .btn-save { background: var(--primary); color: white; }

        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="search" class="search-box" placeholder="Tìm kiếm..." oninput="render()">
        </div>
        <div class="badge" id="counter">0</div>
        <i class="fas fa-cog header-btn" onclick="openSettings()"></i>
    </div>

    <div class="container" id="list"></div>

    <div class="fab" onclick="openModal()"><i class="fas fa-plus"></i></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 style="margin-top:0; color:var(--primary)">Thông tin</h2>
            <input type="hidden" id="editId">
            <div class="inp-group">
                <label class="inp-label">Nguồn (Web/App)</label>
                <input type="text" id="inpWeb" class="inp" placeholder="VD: facebook.com" onblur="autoFillName()">
            </div>
            <div class="inp-group">
                <label class="inp-label">Tên hiển thị</label>
                <input type="text" id="inpName" class="inp">
            </div>
            <div class="inp-group">
                <label class="inp-label">Tài khoản / ID</label>
                <input type="text" id="inpUser" class="inp">
            </div>
            <div class="inp-group">
                <label class="inp-label">Mã bảo mật / Token</label>
                <input type="text" id="inpPass" class="inp">
            </div>
            <div class="inp-group">
                <label class="inp-label">Ghi chú</label>
                <textarea id="inpNote" class="inp" style="height:80px; resize:none"></textarea>
            </div>
            <div class="btn-row">
                <button class="btn btn-close" onclick="closeModal('modal')">Hủy</button>
                <button class="btn btn-save" onclick="saveData()">Lưu</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2 style="margin-top:0; color:var(--primary)">Cài đặt</h2>
            
            <div class="inp-group">
                <label class="inp-label">Đồng bộ Cloud (Sync)</label>
                <div class="sync-row">
                    <input type="password" id="syncPassInput" class="inp" placeholder="Nhập mã sync...">
                    <button class="btn-sync" onclick="syncCloud('load')"><i class="fas fa-cloud-download-alt"></i> TẢI VỀ</button>
                </div>
                <p style="font-size:11px; color:#666; margin-top:5px">Nhập mã và ấn nút Tải về để đồng bộ dữ liệu.</p>
            </div>
            
            <button class="btn btn-close" style="width:100%" onclick="syncCloud('save')">⬆ Gửi dữ liệu lên Cloud</button>

            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

            <div class="inp-group">
                <label class="inp-label">Mật khẩu Backup ZIP (Telegram)</label>
                <input type="password" id="zipPassInput" class="inp" placeholder="Nhập pass giải nén...">
                <button class="btn btn-close" style="width:100%; margin-top:5px" onclick="saveConfig()">Lưu Pass ZIP</button>
            </div>

            <button class="btn btn-close" style="width:100%; margin-top:10px" onclick="closeModal('settingsModal')">Đóng</button>
        </div>
    </div>

    <script>
        const WORKER_URL = "https://access-with-me.doicucden.workers.dev/"; 
        let vault = JSON.parse(localStorage.getItem('vault_safe_v1')) || [];
        
        window.addEventListener('load', () => {
            if(window.zip) zip.configure({ useWebWorkers: false });
            
            document.getElementById('zipPassInput').value = localStorage.getItem('zip_pass') || '';
            document.getElementById('syncPassInput').value = localStorage.getItem('sync_pass') || '';
            
            render();
            
            // Register PWA Service Worker
            if('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('SW Registered'))
                .catch(e => console.error('SW Fail', e));
            }
        });

        // --- RENDER ---
        function getFavicon(url) {
            if (!url) return 'https://cdn-icons-png.flaticon.com/512/1000/1000997.png';
            let domain = url.replace('https://', '').replace('http://', '').split('/')[0];
            return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
        }

        function render() {
            const q = document.getElementById('search').value.toLowerCase();
            const list = document.getElementById('list');
            list.innerHTML = '';
            
            const filtered = vault.filter(i => (i.name||'').toLowerCase().includes(q) || (i.web||'').toLowerCase().includes(q));
            
            // Update counter
            document.getElementById('counter').innerText = vault.length;

            filtered.forEach(item => {
                let fullLink = (item.web && item.web.startsWith('http')) ? item.web : 'https://' + item.web;
                
                list.innerHTML += `
                    <div class="card">
                        <div class="card-top">
                            <div class="brand-info">
                                <img src="${getFavicon(item.web)}" class="brand-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1000/1000997.png'">
                                <span class="brand-name">${item.name}</span>
                            </div>
                            <div class="card-actions">
                                <i class="fas fa-pen action-icon" onclick="openModal(${item.id})"></i>
                                <i class="fas fa-trash action-icon del" onclick="deleteItem(${item.id})"></i>
                            </div>
                        </div>

                        <div class="field-group">
                            <div class="field-content">
                                <div class="field-label">TÀI KHOẢN / ID</div>
                                <div class="field-value">${item.user}</div>
                            </div>
                            <button class="copy-btn" onclick="copy(this, '${item.user}')">COPY</button>
                        </div>

                        <div class="field-group">
                            <div class="field-content">
                                <div class="field-label">MÃ BẢO MẬT / TOKEN</div>
                                <div class="field-value">••••••••</div>
                            </div>
                            <i class="fas fa-eye" style="color:#aaa; padding:10px; cursor:pointer" onclick="togglePass(this, '${item.pass}')"></i>
                            <button class="copy-btn" onclick="copy(this, '${item.pass}')">COPY</button>
                        </div>

                        ${item.note ? `<div class="note-box"><i class="fas fa-sticky-note"></i> <span>${item.note}</span></div>` : ''}
                        
                        <a href="${fullLink}" target="_blank" class="web-link">Truy cập Website <i class="fas fa-external-link-alt"></i></a>
                    </div>
                `;
            });
        }

        // --- ACTIONS ---
        function togglePass(icon, pass) {
            const valDiv = icon.previousElementSibling.querySelector('.field-value');
            if(valDiv.innerText === '••••••••') {
                valDiv.innerText = pass;
                icon.className = "fas fa-eye-slash"; icon.style.color = "var(--primary)";
            } else {
                valDiv.innerText = '••••••••';
                icon.className = "fas fa-eye"; icon.style.color = "#aaa";
            }
        }

        function copy(btn, txt) {
            navigator.clipboard.writeText(txt);
            let old = btn.innerText;
            btn.innerText = "OK"; btn.classList.add('copied');
            setTimeout(() => { btn.innerText = old; btn.classList.remove('copied'); }, 1500);
        }

        function autoFillName() {
            const web = document.getElementById('inpWeb').value;
            const name = document.getElementById('inpName');
            if(web && !name.value) {
                let d = web.replace('https://','').replace('http://','').split('/')[0].replace('www.','');
                name.value = d.split('.')[0].charAt(0).toUpperCase() + d.split('.')[0].slice(1);
            }
        }

        // --- CRUD ---
        function openModal(id = null) {
            document.getElementById('modal').style.display = 'flex';
            ['inpWeb','inpName','inpUser','inpPass','inpNote','editId'].forEach(k => document.getElementById(k).value = '');
            
            if (id) {
                const item = vault.find(i => i.id === id);
                if(item) {
                    document.getElementById('editId').value = id;
                    document.getElementById('inpWeb').value = item.web || '';
                    document.getElementById('inpName').value = item.name || '';
                    document.getElementById('inpUser').value = item.user || '';
                    document.getElementById('inpPass').value = item.pass || '';
                    document.getElementById('inpNote').value = item.note || '';
                }
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        
        function saveConfig() {
            localStorage.setItem('zip_pass', document.getElementById('zipPassInput').value);
            alert("Đã lưu pass ZIP!");
        }

        function saveData() {
            const id = document.getElementById('editId').value;
            const item = {
                id: id ? Number(id) : Date.now(),
                web: document.getElementById('inpWeb').value,
                name: document.getElementById('inpName').value,
                user: document.getElementById('inpUser').value,
                pass: document.getElementById('inpPass').value,
                note: document.getElementById('inpNote').value
            };

            if(!item.name) return alert("Vui lòng nhập tên!");

            if(id) {
                const idx = vault.findIndex(i => i.id == id);
                vault[idx] = item;
            } else {
                vault.unshift(item);
            }
            
            localStorage.setItem('vault_safe_v1', JSON.stringify(vault));
            render();
            closeModal('modal');
            autoBackup();
        }

        function deleteItem(id) {
            if(confirm("Xóa mục này?")) {
                vault = vault.filter(i => i.id !== id);
                localStorage.setItem('vault_safe_v1', JSON.stringify(vault));
                render();
                autoBackup();
            }
        }

        // --- WORKER SYNC & BACKUP ---
        async function syncCloud(action) {
            const syncPass = document.getElementById('syncPassInput').value;
            if(!syncPass) return alert("Vui lòng nhập mật khẩu Sync!");
            
            localStorage.setItem('sync_pass', syncPass);
            
            const btn = event.target.closest('button');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
            btn.disabled = true;

            try {
                const payload = {
                    action: action === 'save' ? 'sync_save' : 'sync_load',
                    sync_pass: syncPass,
                    data: action === 'save' ? vault : null
                };

                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if(json.success) {
                    if(action === 'load') {
                        if(json.data && json.data.length > 0) {
                            if(confirm(`Tìm thấy ${json.data.length} mục. Ghi đè vào máy?`)) {
                                vault = json.data;
                                localStorage.setItem('vault_safe_v1', JSON.stringify(vault));
                                render();
                                alert("Đồng bộ thành công!");
                                closeModal('settingsModal');
                            }
                        } else {
                            alert("Không có dữ liệu hoặc sai mã.");
                        }
                    } else {
                        alert("Đã lưu lên Cloud!");
                    }
                } else {
                    alert("Lỗi: " + json.msg);
                }
            } catch(e) {
                alert("Lỗi kết nối: " + e.message);
            }
            btn.innerHTML = oldHtml;
            btn.disabled = false;
        }

        async function autoBackup() {
            const zipPass = localStorage.getItem('zip_pass');
            if(!zipPass) return;

            try {
                let csv = "\uFEFFName,ID,Token,Note\n"; 
                vault.forEach(item => {
                    const row = [item.name, item.user, item.pass, item.note]
                        .map(t => `"${String(t||'').replace(/"/g, '""')}"`).join(",");
                    csv += row + "\n";
                });

                const blobWriter = new zip.BlobWriter("application/zip");
                const zipWriter = new zip.ZipWriter(blobWriter, { password: zipPass, encryptionStrength: 3 });
                await zipWriter.add("safe_data.csv", new zip.TextReader(csv));
                await zipWriter.close();
                const blob = blobWriter.getData();

                const fd = new FormData();
                fd.append('action', 'backup_file');
                fd.append('file', await blob);
                
                await fetch(WORKER_URL, { method: 'POST', body: fd });
            } catch(e) { console.error("Backup err", e); }
        }
    </script>
</body>
</html>
