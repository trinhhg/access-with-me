<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault Safe</title> 
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#175DDC">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.34/dist/zip.min.js"></script>

    <style>
        :root { --primary: #175DDC; --bg: #f2f4f8; --card-bg: #ffffff; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding-top: 60px; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* HEADER UPDATED */
        .header { background: var(--primary); padding: 8px 15px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; align-items: center; height: 50px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); gap: 15px; }
        
        /* SEARCH BOX TINH CHỈNH: Gọn gàng, bo tròn, không bị phình */
        .search-container { flex: 1; position: relative; display: flex; align-items: center; }
        .search-box { 
            width: 100%; 
            height: 36px; /* Chiều cao cố định để không bị phình */
            padding: 0 15px 0 40px; /* Padding trái phải, Top/Bottom để 0 để dùng line-height căn giữa */
            border-radius: 20px; /* Bo tròn vừa đủ (pill shape) */
            border: none; 
            font-size: 14px; 
            background: rgba(255,255,255,0.2); 
            color: white; 
            outline: none; 
            transition: background 0.2s;
            line-height: normal; /* Fix lỗi chữ bị lệch trên một số trình duyệt */
        }
        .search-box:focus { background: rgba(255,255,255,0.3); }
        .search-box::placeholder { color: rgba(255,255,255,0.7); }
        .search-icon { position: absolute; left: 12px; color: rgba(255,255,255,0.8); font-size: 14px; pointer-events: none; }
        
        .header-btn { color: white; font-size: 20px; cursor: pointer; padding: 5px; flex-shrink: 0; }
        
        /* BADGE */
        .badge { position: absolute; top: 5px; right: 45px; background: #ff4757; color: white; font-size: 9px; padding: 2px 5px; border-radius: 10px; font-weight: bold; pointer-events: none; }

        /* LIST CARD */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        
        .card-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .brand-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .brand-logo { width: 32px; height: 32px; border-radius: 6px; object-fit: contain; flex-shrink: 0; }
        .brand-name { font-weight: 700; font-size: 16px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .card-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .action-icon { color: #999; font-size: 16px; cursor: pointer; padding: 5px; }
        .action-icon.del { color: #ff6b6b; }

        .field-group { margin-bottom: 10px; background: #f9f9f9; padding: 8px 10px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; }
        .field-content { flex: 1; overflow: hidden; margin-right: 10px; }
        .field-label { font-size: 9px; color: #999; text-transform: uppercase; margin-bottom: 3px; font-weight: 700; }
        .field-value { font-size: 14px; font-family: 'Roboto Mono', monospace; color: #333; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .copy-btn { background: white; border: 1px solid #dee2e6; color: var(--primary); font-weight: 700; font-size: 10px; padding: 5px 10px; border-radius: 4px; min-width: 50px; cursor: pointer; }
        .copy-btn.copied { background: #27ae60; color: white; border-color: #27ae60; }
        
        .note-box { background: #fff8e1; color: #d35400; padding: 8px; border-radius: 6px; font-size: 13px; margin-top: 8px; display: flex; gap: 6px; }
        .web-link { display: block; text-align: right; margin-top: 10px; font-size: 12px; color: var(--primary); text-decoration: none; font-weight: 600; }

        .fab { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 8px 20px rgba(23, 93, 220, 0.3); z-index: 200; cursor: pointer; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 380px; border-radius: 16px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popUp 0.15s ease-out; }
        .inp-group { margin-bottom: 12px; }
        .inp-label { display: block; font-size: 11px; font-weight: 700; color: #555; margin-bottom: 4px; }
        .inp { width: 100%; padding: 10px; border: 1px solid #eee; background: #f8f9fa; border-radius: 8px; font-size: 15px; box-sizing: border-box; outline: none; }
        .inp:focus { border-color: var(--primary); background: white; }
        
        /* SYNC BUTTONS */
        .sync-row { display: flex; gap: 5px; }
        .sync-row .inp { flex: 1; }
        .btn-action { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px; min-width: 80px; }
        
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; font-size: 14px; cursor: pointer; }
        .btn-close { background: #f1f3f5; color: #333; }
        .btn-save { background: var(--primary); color: white; }
        
        #status-bar { position: fixed; top: 60px; left:0; right:0; text-align:center; padding: 5px; font-size: 11px; background: #333; color: white; display: none; z-index:900; }

        @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="search" class="search-box" placeholder="Tìm kiếm..." oninput="render()">
        </div>
        
        <div class="badge" id="counter">0</div>
        <i class="fas fa-cog header-btn" onclick="openSettings()"></i>
    </div>

    <div id="status-bar"></div>
    <div class="container" id="list"></div>
    <div class="fab" onclick="openModal()"><i class="fas fa-plus"></i></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 style="margin:0 0 15px 0; color:var(--primary)">Thông tin</h3>
            <input type="hidden" id="editId">
            <div class="inp-group">
                <label class="inp-label">Website / App</label>
                <input type="text" id="inpWeb" class="inp" placeholder="VD: google.com" onblur="autoFillName()">
            </div>
            <div class="inp-group">
                <label class="inp-label">Tên hiển thị</label>
                <input type="text" id="inpName" class="inp">
            </div>
            <div class="inp-group">
                <label class="inp-label">Tài khoản / ID</label>
                <input type="text" id="inpUser" class="inp">
            </div>
            <div class="inp-group">
                <label class="inp-label">Mã bảo mật / Token</label>
                <input type="text" id="inpPass" class="inp">
            </div>
            <div class="inp-group">
                <label class="inp-label">Ghi chú</label>
                <textarea id="inpNote" class="inp" style="height:60px; resize:none"></textarea>
            </div>
            <div class="btn-row">
                <button class="btn btn-close" onclick="closeModal('modal')">Hủy</button>
                <button class="btn btn-save" onclick="saveData()">Lưu</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3 style="margin:0 0 15px 0; color:var(--primary)">Cài đặt</h3>
            
            <div class="inp-group">
                <label class="inp-label">Đồng bộ Cloud (Sync)</label>
                <div class="sync-row">
                    <input type="password" id="syncPassInput" class="inp" placeholder="Nhập pass sync...">
                    <button class="btn-action" onclick="handleSyncBtn(this, 'load')"><i class="fas fa-cloud-download-alt"></i> TẢI VỀ</button>
                </div>
            </div>
            
            <button class="btn btn-close" style="width:100%; display:flex; justify-content:center; align-items:center; gap:5px" onclick="handleSyncBtn(this, 'save')">
                <i class="fas fa-cloud-upload-alt"></i> Gửi thủ công lên Cloud
            </button>

            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

            <div class="inp-group">
                <label class="inp-label">Mật khẩu Backup ZIP (Telegram)</label>
                <div class="sync-row">
                     <input type="password" id="zipPassInput" class="inp" placeholder="Nhập pass giải nén...">
                     <button class="btn-action" style="background:#333" onclick="saveZipPass(this)">LƯU</button>
                </div>
                <p style="font-size:10px; color:#d35400; margin-top:5px">Lưu xong sẽ tự gửi backup ngay lập tức.</p>
            </div>

            <button class="btn btn-close" style="width:100%; margin-top:10px" onclick="closeModal('settingsModal')">Đóng</button>
        </div>
    </div>

    <script>
        const WORKER_URL = "https://access-with-me.doicucden.workers.dev/"; 
        let vault = JSON.parse(localStorage.getItem('vault_final_v1')) || [];
        
        window.addEventListener('load', () => {
            if(window.zip) zip.configure({ useWebWorkers: false });
            
            document.getElementById('zipPassInput').value = localStorage.getItem('zip_pass') || '';
            document.getElementById('syncPassInput').value = localStorage.getItem('sync_pass') || '';
            
            render();
            checkNet();
            
            if('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                .then(() => console.log("SW OK"))
                .catch(console.error);
            }
        });

        window.addEventListener('online', checkNet);
        window.addEventListener('offline', checkNet);

        function checkNet() {
            const bar = document.getElementById('status-bar');
            if(!navigator.onLine) {
                bar.innerText = "Đang Offline. Dữ liệu sẽ được lưu vào hàng đợi.";
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
                processQueue();
            }
        }

        async function processQueue() {
            if(localStorage.getItem('queue_sync')) {
                await performSync('save', localStorage.getItem('sync_pass'), true);
                localStorage.removeItem('queue_sync');
            }
            if(localStorage.getItem('queue_backup')) {
                await performBackup(true);
                localStorage.removeItem('queue_backup');
            }
        }

        // --- HÀM CALL API CHUẨN (FIX CORS) ---
        async function callWorker(payload, isFile = false) {
            if(!navigator.onLine) throw new Error("Offline");

            let options = {
                method: 'POST',
            };

            if (isFile) {
                options.body = payload;
            } else {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(payload);
            }

            const res = await fetch(WORKER_URL, options);
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || res.statusText);
            }
            return await res.json();
        }

        // --- RENDER ---
        function getFavicon(url) {
            if (!url) return 'https://cdn-icons-png.flaticon.com/512/1000/1000997.png';
            let domain = url.replace('https://', '').replace('http://', '').split('/')[0];
            return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
        }

        function render() {
            const q = document.getElementById('search').value.toLowerCase();
            const list = document.getElementById('list');
            list.innerHTML = '';
            
            const filtered = vault.filter(i => (i.name||'').toLowerCase().includes(q) || (i.web||'').toLowerCase().includes(q));
            document.getElementById('counter').innerText = vault.length;

            filtered.forEach(item => {
                let fullLink = (item.web && item.web.startsWith('http')) ? item.web : 'https://' + item.web;
                list.innerHTML += `
                    <div class="card">
                        <div class="card-top">
                            <div class="brand-info">
                                <img src="${getFavicon(item.web)}" class="brand-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1000/1000997.png'">
                                <span class="brand-name">${item.name}</span>
                            </div>
                            <div class="card-actions">
                                <i class="fas fa-pen action-icon" onclick="openModal(${item.id})"></i>
                                <i class="fas fa-trash action-icon del" onclick="deleteItem(${item.id})"></i>
                            </div>
                        </div>
                        <div class="field-group">
                            <div class="field-content">
                                <div class="field-label">TÀI KHOẢN / ID</div>
                                <div class="field-value">${item.user}</div>
                            </div>
                            <button class="copy-btn" onclick="copy(this, '${item.user}')">COPY</button>
                        </div>
                        <div class="field-group">
                            <div class="field-content">
                                <div class="field-label">MÃ BẢO MẬT / TOKEN</div>
                                <div class="field-value">••••••••</div>
                            </div>
                            <i class="fas fa-eye" style="color:#aaa; padding:10px; cursor:pointer" onclick="togglePass(this, '${item.pass}')"></i>
                            <button class="copy-btn" onclick="copy(this, '${item.pass}')">COPY</button>
                        </div>
                        ${item.note ? `<div class="note-box"><i class="fas fa-sticky-note"></i> <span>${item.note}</span></div>` : ''}
                        <a href="${fullLink}" target="_blank" class="web-link">Truy cập <i class="fas fa-external-link-alt"></i></a>
                    </div>
                `;
            });
        }

        // --- ACTIONS ---
        function togglePass(icon, pass) {
            const valDiv = icon.previousElementSibling.querySelector('.field-value');
            if(valDiv.innerText === '••••••••') {
                valDiv.innerText = pass;
                icon.className = "fas fa-eye-slash"; icon.style.color = "var(--primary)";
            } else {
                valDiv.innerText = '••••••••';
                icon.className = "fas fa-eye"; icon.style.color = "#aaa";
            }
        }

        function copy(btn, txt) {
            navigator.clipboard.writeText(txt);
            let old = btn.innerText;
            btn.innerText = "OK"; btn.classList.add('copied');
            setTimeout(() => { btn.innerText = old; btn.classList.remove('copied'); }, 1500);
        }

        function autoFillName() {
            const web = document.getElementById('inpWeb').value;
            const name = document.getElementById('inpName');
            if(web && !name.value) {
                let d = web.replace('https://','').replace('http://','').split('/')[0].replace('www.','');
                name.value = d.split('.')[0].charAt(0).toUpperCase() + d.split('.')[0].slice(1);
            }
        }

        // --- CRUD + AUTO TRIGGER ---
        function openModal(id = null) {
            document.getElementById('modal').style.display = 'flex';
            ['inpWeb','inpName','inpUser','inpPass','inpNote','editId'].forEach(k => document.getElementById(k).value = '');
            if (id) {
                const item = vault.find(i => i.id === id);
                if(item) {
                    document.getElementById('editId').value = id;
                    document.getElementById('inpWeb').value = item.web || '';
                    document.getElementById('inpName').value = item.name || '';
                    document.getElementById('inpUser').value = item.user || '';
                    document.getElementById('inpPass').value = item.pass || '';
                    document.getElementById('inpNote').value = item.note || '';
                }
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }

        function saveData() {
            const id = document.getElementById('editId').value;
            const item = {
                id: id ? Number(id) : Date.now(),
                web: document.getElementById('inpWeb').value,
                name: document.getElementById('inpName').value,
                user: document.getElementById('inpUser').value,
                pass: document.getElementById('inpPass').value,
                note: document.getElementById('inpNote').value
            };

            if(!item.name) return alert("Vui lòng nhập tên!");

            if(id) {
                const idx = vault.findIndex(i => i.id == id);
                vault[idx] = item;
            } else {
                vault.unshift(item);
            }
            
            triggerAutoSystems();
            closeModal('modal');
        }

        function deleteItem(id) {
            if(confirm("Xóa mục này?")) {
                vault = vault.filter(i => i.id !== id);
                triggerAutoSystems();
            }
        }

        function triggerAutoSystems() {
            localStorage.setItem('vault_final_v1', JSON.stringify(vault));
            render();
            
            // Auto Sync (Silent)
            const syncPass = localStorage.getItem('sync_pass');
            if(syncPass) performSync('save', syncPass, true);

            // Auto Backup (Silent)
            performBackup(true);
        }

        // --- BACKUP ZIP (FIXED AES-256 + CORS) ---
        function saveZipPass(btn) {
            const val = document.getElementById('zipPassInput').value;
            if(val) {
                localStorage.setItem('zip_pass', val);
                const old = btn.innerText;
                btn.innerText = "LƯU OK";
                // TRIGGER BACKUP NGAY LẬP TỨC
                performBackup(true);
                setTimeout(()=>btn.innerText=old, 1500);
            }
        }

        async function performBackup(isAuto = false) {
            const zipPass = localStorage.getItem('zip_pass');
            if(!zipPass) {
                if(isAuto) localStorage.setItem('queue_backup', 'true');
                return;
            }

            if(!navigator.onLine) {
                localStorage.setItem('queue_backup', 'true');
                return;
            }

            try {
                let today = new Date().toLocaleDateString('vi-VN').replace(/\//g,'-');
                let lastDate = localStorage.getItem('last_backup_date');
                let count = 1;
                
                if (lastDate === today) {
                    count = parseInt(localStorage.getItem('backup_count') || '0') + 1;
                }
                
                localStorage.setItem('last_backup_date', today);
                localStorage.setItem('backup_count', count);
                let fileName = `data_lan_${count}.csv`;

                let csv = "\uFEFFName,ID,Token,Note\n"; 
                vault.forEach(item => {
                    const row = [item.name, item.user, item.pass, item.note]
                        .map(t => `"${String(t||'').replace(/"/g, '""')}"`).join(",");
                    csv += row + "\n";
                });

                // TẠO ZIP AES-256 CHUẨN
                const blobWriter = new zip.BlobWriter("application/zip");
                const zipWriter = new zip.ZipWriter(blobWriter, { 
                    password: zipPass, 
                    encryptionStrength: 3, 
                    zipCrypto: false, 
                    dataDescriptorSignature: true 
                });

                await zipWriter.add(fileName, new zip.TextReader(csv));
                await zipWriter.close();
                const blob = await blobWriter.getData();

                const fd = new FormData();
                fd.append('action', 'backup_file');
                fd.append('file', blob, "backup_encrypted.zip"); 
                
                // GỌI HÀM CALLWORKER (CORS FIX)
                await callWorker(fd, true);
                console.log("Backup encrypted sent: " + fileName);

            } catch(e) {
                console.error("Backup Fail", e);
            }
        }

        // --- SYNC LOGIC (FIX CORS) ---
        async function handleSyncBtn(btn, action) {
            const pass = document.getElementById('syncPassInput').value;
            if(!pass) return alert("Chưa nhập pass!");
            localStorage.setItem('sync_pass', pass);
            
            const oldTxt = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang tải...`;
            btn.disabled = true;

            try {
                await performSync(action, pass, false);
                btn.innerHTML = `<i class="fas fa-check"></i> Xong!`;
                if(action === 'load') closeModal('settingsModal');
            } catch(e) {
                btn.innerHTML = `❌ Lỗi`;
                alert(e.message);
            }
            
            setTimeout(() => {
                btn.innerHTML = oldTxt;
                btn.disabled = false;
            }, 2000);
        }

        async function performSync(action, pass, isAuto) {
            if(!navigator.onLine) {
                if(isAuto) localStorage.setItem('queue_sync', 'true');
                throw new Error("Offline");
            }

            const payload = {
                action: action === 'save' ? 'sync_save' : 'sync_load',
                sync_pass: pass,
                data: action === 'save' ? vault : null
            };

            // GỌI HÀM CALLWORKER (CORS FIX)
            const json = await callWorker(payload, false);

            if(!json.success) throw new Error(json.msg);

            if(action === 'load') {
                if(json.data && json.data.length) {
                    vault = json.data;
                    localStorage.setItem('vault_final_v1', JSON.stringify(vault));
                    render();
                } else {
                    throw new Error("Không có dữ liệu trên Cloud");
                }
            }
        }
    </script>
</body>
</html>
