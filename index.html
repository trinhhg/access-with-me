<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Personal Manager</title> 
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.34/dist/zip.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; --text: #333; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-top: 80px; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* HEADER */
        .header { background: #fff; padding: 10px 15px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; height: 60px; }
        .search-box { flex: 1; background: #f1f3f5; border: none; padding: 10px 15px; border-radius: 8px; font-size: 15px; outline: none; color: #333; }
        .header-icon { font-size: 20px; color: var(--primary); padding: 8px; cursor: pointer; }

        /* CARD STYLE */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #eee; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .app-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .app-logo { width: 28px; height: 28px; border-radius: 6px; object-fit: contain; }
        .app-name { font-weight: 600; font-size: 16px; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .field-row { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 8px 10px; border-radius: 6px; margin-bottom: 8px; }
        .field-info { flex: 1; overflow: hidden; margin-right: 8px; }
        .field-label { font-size: 10px; color: #888; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .field-val { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #333; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .action-btn { border: none; background: none; color: #999; cursor: pointer; padding: 5px; font-size: 14px; }
        .copy-tag { background: white; border: 1px solid #ddd; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; color: var(--primary); cursor: pointer; }
        .copy-tag.active { background: #27ae60; color: white; border-color: #27ae60; }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3); z-index: 200; cursor: pointer; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideUp 0.2s; }
        .inp-wrap { margin-bottom: 15px; }
        .inp-label { display: block; font-size: 12px; color: #666; font-weight: 600; margin-bottom: 5px; }
        .inp { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; box-sizing: border-box; outline: none; }
        .inp:focus { border-color: var(--primary); }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sec { background: #f1f3f5; color: #333; }

        #statusMsg { font-size: 12px; text-align: center; margin-bottom: 10px; font-weight: 600; height: 15px; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <input type="text" id="search" class="search-box" placeholder="Tìm kiếm nhanh..." oninput="render()">
        <i class="fas fa-cloud-upload-alt header-icon" onclick="openSettings()"></i>
    </div>

    <div class="container">
        <div id="statusMsg"></div>
        <div id="list"></div>
    </div>

    <div class="fab" onclick="openEditor()"><i class="fas fa-plus"></i></div>

    <div class="modal" id="editorModal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--primary)">Thông tin mục</h3>
            <input type="hidden" id="itemId">
            
            <div class="inp-wrap">
                <label class="inp-label">Nguồn / Link</label>
                <input type="text" id="in_src" class="inp" placeholder="VD: google.com" onblur="autoParseName()">
            </div>
            <div class="inp-wrap">
                <label class="inp-label">Tên gợi nhớ</label>
                <input type="text" id="in_name" class="inp">
            </div>
            <div class="inp-wrap">
                <label class="inp-label">Định danh (ID)</label>
                <input type="text" id="in_uid" class="inp">
            </div>
            <div class="inp-wrap">
                <label class="inp-label">Mã Token / Khóa</label>
                <input type="text" id="in_key" class="inp">
            </div>
            <div class="inp-wrap">
                <label class="inp-label">Ghi chú</label>
                <textarea id="in_note" class="inp" style="height:60px; resize:none"></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-sec" onclick="closeModal('editorModal')">Đóng</button>
                <button class="btn btn-primary" onclick="saveItem()">Lưu</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--primary)">Cấu hình & Backup</h3>
            
            <div class="inp-wrap">
                <label class="inp-label">Mã ZIP (Dùng để Auto Backup)</label>
                <input type="password" id="cfg_zip" class="inp" placeholder="Nhập mã bảo vệ file zip...">
            </div>
            
            <div class="inp-wrap">
                <label class="inp-label">Mã Sync (Cloud)</label>
                <input type="password" id="cfg_sync" class="inp" placeholder="Mã bí mật để đồng bộ...">
            </div>

            <div class="btn-group" style="margin-bottom:10px">
                <button class="btn btn-primary" onclick="triggerSync('save')">⬆ Gửi lên Cloud</button>
                <button class="btn btn-sec" onclick="triggerSync('load')">⬇ Tải về máy</button>
            </div>
            
            <button class="btn btn-sec" style="width:100%" onclick="saveConfigs()">Lưu Cấu Hình</button>
            
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px">
                 <button class="btn btn-sec" style="width:100%" onclick="document.getElementById('importFile').click()"><i class="fas fa-file-import"></i> Restore từ File ZIP</button>
                 <input type="file" id="importFile" hidden accept=".zip" onchange="restoreFromFile(this)">
            </div>
            <button class="btn btn-sec" style="width:100%; margin-top:5px" onclick="closeModal('settingsModal')">Đóng</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // Thay link worker của bạn vào đây:
        const API_URL = "https://access-with-me.doicucden.workers.dev/"; 

        let db = JSON.parse(localStorage.getItem('my_data_store')) || [];

        window.addEventListener('load', () => {
            if(window.zip) zip.configure({ useWebWorkers: false });
            
            document.getElementById('cfg_zip').value = localStorage.getItem('cfg_zip') || '';
            document.getElementById('cfg_sync').value = localStorage.getItem('cfg_sync') || '';
            render();

            if('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
        });

        // --- CORE LOGIC ---
        function getFavicon(url) {
            if (!url) return 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'; // Icon cái khiên
            let domain = url.replace('https://', '').replace('http://', '').split('/')[0];
            return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
        }

        function autoParseName() {
            const src = document.getElementById('in_src').value;
            const name = document.getElementById('in_name');
            if (src && !name.value) {
                let d = src.replace('https://', '').replace('http://', '').split('/')[0].replace('www.', '');
                name.value = d.split('.')[0].toUpperCase();
            }
        }

        function render() {
            const q = document.getElementById('search').value.toLowerCase();
            const list = document.getElementById('list');
            list.innerHTML = '';

            const filtered = db.filter(i => (i.n||'').toLowerCase().includes(q) || (i.s||'').toLowerCase().includes(q));

            filtered.forEach(item => {
                let link = (item.s && item.s.startsWith('http')) ? item.s : 'https://' + item.s;
                list.innerHTML += `
                    <div class="card">
                        <div class="card-header">
                            <div class="app-info">
                                <img src="${getFavicon(item.s)}" class="app-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3523/3523063.png'">
                                <div class="app-name">${item.n}</div>
                            </div>
                            <div>
                                <button class="action-btn" onclick="editItem(${item.id})"><i class="fas fa-pen"></i></button>
                                <button class="action-btn" onclick="delItem(${item.id})" style="color:#e74c3c"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        
                        <div class="field-row">
                            <div class="field-info">
                                <div class="field-label">ID / Định danh</div>
                                <div class="field-val">${item.u}</div>
                            </div>
                            <button class="copy-tag" onclick="copyTxt(this, '${item.u}')">COPY</button>
                        </div>

                        <div class="field-row">
                            <div class="field-info">
                                <div class="field-label">Mã Token</div>
                                <div class="field-val">••••••••</div>
                            </div>
                            <i class="fas fa-eye action-btn" onclick="toggleVis(this, '${item.p}')"></i>
                            <button class="copy-tag" onclick="copyTxt(this, '${item.p}')">COPY</button>
                        </div>
                        
                        ${item.nt ? `<div style="font-size:12px; color:#666; background:#fff3cd; padding:5px; margin-top:5px; border-radius:4px">${item.nt}</div>` : ''}
                        
                        <div style="text-align:right; margin-top:5px;">
                            <a href="${link}" target="_blank" style="font-size:11px; color:var(--primary); text-decoration:none">MỞ LIÊN KẾT <i class="fas fa-external-link-alt"></i></a>
                        </div>
                    </div>
                `;
            });
        }

        function copyTxt(el, txt) {
            navigator.clipboard.writeText(txt);
            el.innerText = "ĐÃ COPY"; el.classList.add('active');
            setTimeout(() => { el.innerText = "COPY"; el.classList.remove('active'); }, 1500);
        }

        function toggleVis(icon, txt) {
            const val = icon.previousElementSibling.querySelector('.field-val');
            if(val.innerText === '••••••••') { val.innerText = txt; icon.className = 'fas fa-eye-slash action-btn'; }
            else { val.innerText = '••••••••'; icon.className = 'fas fa-eye action-btn'; }
        }

        // --- CRUD ---
        function openEditor(id=null) {
            document.getElementById('editorModal').style.display = 'flex';
            ['in_src','in_name','in_uid','in_key','in_note','itemId'].forEach(k => document.getElementById(k).value = '');
            if(id) {
                const i = db.find(x => x.id === id);
                document.getElementById('itemId').value = id;
                document.getElementById('in_src').value = i.s || '';
                document.getElementById('in_name').value = i.n || '';
                document.getElementById('in_uid').value = i.u || '';
                document.getElementById('in_key').value = i.p || '';
                document.getElementById('in_note').value = i.nt || '';
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }

        function saveItem() {
            const id = document.getElementById('itemId').value;
            const item = {
                id: id ? Number(id) : Date.now(),
                s: document.getElementById('in_src').value,
                n: document.getElementById('in_name').value,
                u: document.getElementById('in_uid').value,
                p: document.getElementById('in_key').value,
                nt: document.getElementById('in_note').value
            };

            if(!item.n) return alert("Cần nhập tên!");

            if(id) db[db.findIndex(x=>x.id==id)] = item;
            else db.unshift(item);

            localStorage.setItem('my_data_store', JSON.stringify(db));
            render();
            closeModal('editorModal');
            
            // Trigger Backup
            backupToCloud();
        }

        function delItem(id) {
            if(confirm("Xóa mục này?")) {
                db = db.filter(x => x.id !== id);
                localStorage.setItem('my_data_store', JSON.stringify(db));
                render();
                backupToCloud();
            }
        }

        function saveConfigs() {
            localStorage.setItem('cfg_zip', document.getElementById('cfg_zip').value);
            localStorage.setItem('cfg_sync', document.getElementById('cfg_sync').value);
            alert("Đã lưu cấu hình!");
        }

        // --- BACKUP & SYNC ---
        async function createZipBlob(pass) {
            const blobWriter = new zip.BlobWriter("application/zip");
            const zipWriter = new zip.ZipWriter(blobWriter, { password: pass, encryptionStrength: 3 });
            
            // Tạo CSV Content
            let csv = "\uFEFFName,ID,Token,Note,Source\n";
            db.forEach(i => {
                const row = [i.n, i.u, i.p, i.nt, i.s].map(t => `"${String(t||'').replace(/"/g, '""')}"`).join(",");
                csv += row + "\n";
            });

            await zipWriter.add("safe_data.csv", new zip.TextReader(csv));
            await zipWriter.close();
            return blobWriter.getData();
        }

        async function backupToCloud() {
            const pass = localStorage.getItem('cfg_zip');
            const status = document.getElementById('statusMsg');
            if(!pass) return; // Không có pass thì không backup

            status.innerText = "⏳ Đang backup...";
            status.style.color = "blue";

            try {
                const blob = await createZipBlob(pass);
                const fd = new FormData();
                fd.append('action', 'backup_file');
                fd.append('file', blob);

                // Quan trọng: Không set Content-Type header thủ công khi gửi FormData
                const res = await fetch(API_URL, { method: 'POST', body: fd });
                if(res.ok) {
                    status.innerText = "✅ Đã backup an toàn";
                    status.style.color = "green";
                    setTimeout(() => status.innerText = "", 3000);
                } else {
                    status.innerText = "❌ Lỗi backup";
                    status.style.color = "red";
                }
            } catch(e) {
                console.error(e);
                status.innerText = "❌ Lỗi mạng";
                status.style.color = "red";
            }
        }

        async function triggerSync(action) {
            const pass = document.getElementById('cfg_sync').value;
            if(!pass) return alert("Cần nhập mã Sync!");
            
            const btn = event.target;
            const orgTxt = btn.innerText;
            btn.innerText = "⏳ ...";

            try {
                const body = {
                    action: action === 'save' ? 'sync_save' : 'sync_load',
                    sync_pass: pass,
                    data: action === 'save' ? db : null
                };

                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const json = await res.json();
                if(json.success) {
                    if(action === 'load') {
                        if(confirm(`Tìm thấy ${json.data.length} mục. Ghi đè?`)) {
                            db = json.data;
                            localStorage.setItem('my_data_store', JSON.stringify(db));
                            render();
                        }
                    } else {
                        alert("Đồng bộ thành công!");
                    }
                } else {
                    alert("Lỗi: " + json.msg);
                }
            } catch(e) {
                alert("Lỗi kết nối: " + e.message);
            }
            btn.innerText = orgTxt;
        }

        // --- RESTORE ---
        async function restoreFromFile(input) {
            const file = input.files[0];
            if(!file) return;
            const pass = prompt("Nhập mật khẩu file ZIP:");
            if(!pass) return;

            try {
                const reader = new zip.ZipReader(new zip.BlobReader(file));
                const entries = await reader.getEntries();
                if(entries.length) {
                    const text = await entries[0].getData(new zip.TextWriter(), { password: pass });
                    // Simple CSV Parse
                    const lines = text.split('\n');
                    const newData = [];
                    for(let i=1; i<lines.length; i++) {
                        if(!lines[i].trim()) continue;
                        // Regex tách CSV
                        const parts = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        if(parts && parts.length >= 3) {
                            const cols = parts.map(c => c.replace(/^"|"$/g, ''));
                            newData.push({
                                id: Date.now() + i,
                                n: cols[0], u: cols[1], p: cols[2], nt: cols[3]||'', s: cols[4]||''
                            });
                        }
                    }
                    if(newData.length && confirm(`Restore ${newData.length} mục?`)) {
                        db = newData;
                        localStorage.setItem('my_data_store', JSON.stringify(db));
                        render();
                    }
                }
                await reader.close();
            } catch(e) {
                alert("Sai mật khẩu hoặc lỗi file!");
            }
        }
    </script>
</body>
</html>
