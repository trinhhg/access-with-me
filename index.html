<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Config</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#175DDC">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #175DDC; --bg: #f2f4f8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-top: 80px; padding-bottom: 100px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER & SEARCH */
        .header { background: var(--primary); padding: 15px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .search-container { position: relative; flex: 1; }
        .search-box { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: none; font-size: 16px; background: rgba(255,255,255,0.2); color: white; outline: none; }
        .search-box::placeholder { color: rgba(255,255,255,0.7); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.7); }
        .settings-btn { color: white; font-size: 20px; padding: 10px; cursor: pointer; }

        /* LIST & CARDS */
        .container { padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-top { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .brand-name { font-weight: bold; color: #2c3e50; font-size: 16px; }
        .icon-btn { color: #95a5a6; padding: 5px; cursor: pointer; }
        .icon-btn.del { color: #e74c3c; }

        .data-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .data-val { font-family: 'Roboto Mono', monospace; font-weight: 600; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 160px; }
        .copy-btn { background: white; border: 1px solid #ddd; color: var(--primary); font-size: 11px; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .copy-btn.copied { background: #27ae60; color: white; border-color: #27ae60; }
        
        .note-block { background: #fff8e1; color: #d35400; padding: 8px; border-radius: 6px; font-size: 13px; margin-top: 5px; display: flex; gap: 5px; }

        /* FAB & MODAL */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 55px; height: 55px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 5px 15px rgba(23, 93, 220, 0.4); cursor: pointer; z-index: 200; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 85%; border-radius: 15px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .inp-group { margin-bottom: 12px; }
        .inp-group label { display: block; font-size: 12px; color: #666; font-weight: bold; margin-bottom: 4px; }
        .inp { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 15px; margin-top: 10px; cursor: pointer; }
        .btn-save { background: var(--primary); color: white; }
        .btn-close { background: #eee; color: #555; margin-top: 5px;}

        /* SYNC & PASS UI */
        .sync-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .sync-col { flex: 1; }
        .mini-btn { padding: 10px; border-radius: 8px; border: none; color: white; cursor: pointer; font-size: 16px; width: 45px; height: 42px;}
        .btn-blue { background: #3498db; }
        .btn-green { background: #27ae60; }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="search" class="search-box" placeholder="Search config..." oninput="render()">
        </div>
        <i class="fas fa-cog settings-btn" onclick="openSettings()"></i>
    </div>

    <div class="container">
        <div id="statusMsg" style="text-align:center; font-size:12px; height:20px; margin-bottom:10px;"></div>
        <div id="list"></div>
    </div>

    <div class="fab" onclick="openModal()"><i class="fas fa-plus"></i></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary)">Cấu hình</h3>
            <input type="hidden" id="editId">
            <div class="inp-group">
                <label>Tên dịch vụ (Facebook, Youtube...)</label>
                <input type="text" id="inpName" class="inp" placeholder="Service Name">
            </div>
            <div class="inp-group">
                <label>Tên đăng nhập</label>
                <input type="text" id="inpUser" class="inp">
            </div>
            <div class="inp-group">
                <label>Mật khẩu</label>
                <input type="text" id="inpPass" class="inp">
            </div>
            <div class="inp-group">
                <label>Ghi chú</label>
                <input type="text" id="inpNote" class="inp">
            </div>
            <div class="inp-group" style="display:none"> <input type="text" id="inpWeb"> 
            </div>
            <button class="btn btn-save" onclick="saveData()">LƯU LẠI</button>
            <button class="btn btn-close" onclick="closeModal('modal')">ĐÓNG</button>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary)">Cài đặt & Đồng bộ</h3>
            
            <div class="sync-row">
                <div class="sync-col">
                    <label style="font-size:11px; font-weight:bold; color:#666">Mật khẩu Excel Backup</label>
                    <input type="password" id="excelPass" class="inp" placeholder="Nhập để lưu...">
                </div>
                <button class="mini-btn btn-blue" onclick="saveExcelPass()"><i class="fas fa-save"></i></button>
            </div>

            <div class="sync-row">
                <div class="sync-col">
                    <label style="font-size:11px; font-weight:bold; color:#666">Mật khẩu Đồng bộ (Sync)</label>
                    <input type="password" id="syncPass" class="inp" placeholder="Nhập chung cho các máy">
                </div>
                <button class="mini-btn btn-green" onclick="triggerSyncLoad()"><i class="fas fa-cloud-download-alt"></i></button>
            </div>
            
            <p style="font-size:11px; color:#888; margin-top:-5px">
                * Bấm nút <i class="fas fa-cloud-download-alt"></i> để Tải về máy này.<br>
                * Dữ liệu tự động đẩy lên Cloud khi bạn Sửa/Thêm.
            </p>

            <button class="btn btn-close" onclick="closeModal('settingsModal')">ĐÓNG</button>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH ---
        const WORKER_URL = "https://access-with-me.doicucden.workers.dev"; 
        let vault = JSON.parse(localStorage.getItem('vault_v9')) || [];

        // --- KHỞI TẠO ---
        document.addEventListener('DOMContentLoaded', () => {
            render();
            // Load Excel Pass đã lưu
            document.getElementById('excelPass').value = localStorage.getItem('excel_pass_memo') || '';
            // Load Sync Pass đã lưu
            document.getElementById('syncPass').value = localStorage.getItem('sync_pass_memo') || '';
            
            if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        });

        // --- CORE FUNCTIONS ---
        function render() {
            const list = document.getElementById('list');
            const q = document.getElementById('search').value.toLowerCase();
            list.innerHTML = '';

            vault.filter(i => (i.name||'').toLowerCase().includes(q)).forEach(item => {
                let noteHtml = item.note ? `<div class="note-block"><i class="fas fa-sticky-note"></i> ${item.note}</div>` : '';
                
                list.innerHTML += `
                    <div class="card">
                        <div class="card-top">
                            <span class="brand-name">${item.name}</span>
                            <div>
                                <i class="fas fa-pen icon-btn" onclick="openModal(${item.id})"></i>
                                <i class="fas fa-trash icon-btn del" onclick="deleteItem(${item.id})"></i>
                            </div>
                        </div>
                        <div class="data-row">
                            <span class="data-val">${item.user}</span>
                            <button class="copy-btn" onclick="copy(this, '${item.user}')">USER</button>
                        </div>
                        <div class="data-row">
                            <span class="data-val">••••••••</span>
                            <i class="fas fa-eye" style="color:#aaa; padding:5px" onclick="togglePass(this, '${item.pass}')"></i>
                            <button class="copy-btn" onclick="copy(this, '${item.pass}')">PASS</button>
                        </div>
                        ${noteHtml}
                    </div>`;
            });
        }

        // --- ACTIONS ---
        function openModal(id = null) {
            document.getElementById('modal').style.display = 'flex';
            ['inpName','inpUser','inpPass','inpNote','inpWeb','editId'].forEach(k => document.getElementById(k).value = '');
            if(id) {
                const item = vault.find(i => i.id === id);
                document.getElementById('editId').value = id;
                document.getElementById('inpName').value = item.name;
                document.getElementById('inpUser').value = item.user;
                document.getElementById('inpPass').value = item.pass;
                document.getElementById('inpNote').value = item.note || '';
            }
        }

        function saveData() {
            const id = document.getElementById('editId').value;
            const data = {
                id: id ? Number(id) : Date.now(),
                name: document.getElementById('inpName').value,
                user: document.getElementById('inpUser').value,
                pass: document.getElementById('inpPass').value,
                note: document.getElementById('inpNote').value,
                web: '' // Bỏ qua web, giữ structure
            };

            if(!data.name) return alert("Cần nhập tên!");

            if(id) {
                const idx = vault.findIndex(i => i.id == id);
                vault[idx] = data;
            } else {
                vault.unshift(data);
            }
            
            saveToStorage();
            closeModal('modal');
            
            // Tự động Backup & Sync
            pushToWorker('backup');    // Gửi Telegram
            pushToWorker('sync_save'); // Gửi Cloud KV
        }

        function deleteItem(id) {
            if(confirm('Xóa mục này?')) {
                vault = vault.filter(i => i.id !== id);
                saveToStorage();
                pushToWorker('backup');
                pushToWorker('sync_save');
            }
        }

        // --- SYNC & SETTINGS ---
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function saveExcelPass() {
            const val = document.getElementById('excelPass').value;
            localStorage.setItem('excel_pass_memo', val);
            alert("Đã lưu Pass Excel (vào bộ nhớ máy này)");
        }

        async function triggerSyncLoad() {
            const pass = document.getElementById('syncPass').value;
            if(!pass) return alert("Chưa nhập mật khẩu đồng bộ!");
            
            localStorage.setItem('sync_pass_memo', pass); // Nhớ pass này
            showStatus("Đang tải dữ liệu từ Cloud...", "#d35400");

            try {
                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'sync_load', sync_pass: pass })
                });
                const json = await res.json();
                
                if(json.success) {
                    if(confirm(`Tìm thấy ${json.data.length} mục trên Cloud. Ghi đè lên máy này?`)) {
                        vault = json.data;
                        saveToStorage();
                        showStatus("Đồng bộ thành công!", "#27ae60");
                        closeModal('settingsModal');
                    }
                } else {
                    alert(json.msg);
                    showStatus("Lỗi: " + json.msg, "red");
                }
            } catch(e) {
                alert("Lỗi kết nối!");
            }
        }

        async function pushToWorker(actionType) {
            const syncPass = document.getElementById('syncPass').value || localStorage.getItem('sync_pass_memo');
            
            // Nếu action là sync_save mà không có pass thì bỏ qua sync cloud, chỉ backup telegram
            if(actionType === 'sync_save' && !syncPass) return;

            showStatus("Đang sao lưu...", "#d35400");
            try {
                await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: actionType,
                        records: vault,
                        sync_pass: syncPass,
                        data: vault // Dùng cho sync_save
                    })
                });
                showStatus("Đã sao lưu an toàn", "#27ae60");
                setTimeout(() => showStatus("", ""), 3000);
            } catch(e) { console.error(e); }
        }

        // --- UTILS ---
        function saveToStorage() { localStorage.setItem('vault_v9', JSON.stringify(vault)); render(); }
        function showStatus(msg, color) { const el = document.getElementById('statusMsg'); el.innerText = msg; el.style.color = color; }
        function copy(btn, txt) {
            navigator.clipboard.writeText(txt);
            btn.classList.add('copied'); setTimeout(()=>btn.classList.remove('copied'), 1000);
        }
        function togglePass(icon, pass) {
            const span = icon.previousElementSibling;
            if(span.innerText === '••••••••') { span.innerText = pass; icon.className = "fas fa-eye-slash"; }
            else { span.innerText = '••••••••'; icon.className = "fas fa-eye"; }
        }
    </script>
</body>
</html>
